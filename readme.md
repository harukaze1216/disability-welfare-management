# フランチャイズ事業所 実績管理アプリ 要件定義書 (v0.9)

---

## 1. 目的・背景

児童発達支援事業所・放課後等デイサービス・就労支援B型をフランチャイズ展開する本部（以下 **HQ**）が、各事業所（以下 **FC**）の日次実績と売上をリアルタイムで把握・分析するための Web アプリを新規開発する。

当面は **児童発達支援／放課後デイ** の実績登録とダッシュボードを MVP とし、**就労支援B 型** は将来機能拡張で対応する。

---

## 2. 想定ユーザー・権限

| ロール        | 主な操作                                                                                      | 権限範囲   |
| ---------- | ----------------------------------------------------------------------------------------- | ------ |
| **HQ 管理者** | \* 事業所マスタ登録・編集<br>\* ユーザーマスタ登録・編集<br>\* 全データ閲覧・編集<br>\* 集計／ダッシュボード閲覧<br>\* CSV/PDF エクスポート | 全事業所   |
| **FC 管理者** | \* 自事業所の日次実績登録・編集<br>\* 自事業所の在籍児童マスタ編集<br>\* 自事業所ダッシュボード閲覧                                | 自事業所のみ |

> *エリアマネージャー・閲覧専用ユーザーは不要。*

---

## 3. 認証・セキュリティ

| 項目        | 内容                                          |
| --------- | ------------------------------------------- |
| 認証方式      | Firebase Auth（メールアドレス＋パスワード）                |
| パスワード要件   | 8 文字以上／数字+英字混在                              |
| マルチテナント対策 | Firestore ルールで `orgId` を必須クレームにし、組織間アクセスを遮断 |
| 将来拡張      | 2FA・SSO を後日検討できる構成を意識                       |

---

## 4. データモデル（抜粋）

| コレクション            | 主キー                     | 主フィールド                                                                                   |
| ----------------- | ----------------------- | ---------------------------------------------------------------------------------------- |
| **organizations** | orgId                   | name, prefecture, address, facilityType (児発/放デイ/就労B), startDate, endDate (nullable)      |
| **users**         | uid                     | orgId, role (HQ/FC), email, passwordHash, isActive                                       |
| **children**      | childId                 | orgId, name, defaultPickup (bool), defaultDrop (bool)                                    |
| **addOnMaster**   | addOnId                 | name, unitValue, isBasic (bool)                                                          |
| **dailyReports**  | reportId (`orgId+date`) | orgId, date, children\[]:<br>  childId / arrival / departure / pickup / drop / addOns\[] |

> 日次売上計算は Cloud Functions (or Firestore トリガ) で `dailyReports` 更新時に走らせ、`revenues` コレクションへ集計結果を書き込む。

---

## 5. 業務フロー & 機能要件

### 5.1 マスタ管理（HQ 管理者）

1. **事業所マスタ**一括登録（管理画面＋CSV インポート）
2. **ユーザーマスタ**登録（メール通知で初期 PW 発行）
3. **加算マスタ**の登録・編集

   * `isBasic=true` ⇒ 基本単位として常時加算
   * `isBasic=false` ⇒ “随時加算” として児童詳細でチェック選択

### 5.2 日次実績登録（FC 管理者）

1. **日報入力画面**

   * 初期日付＝当日（カレンダー変更可）
   * 在籍児童リストを表示し、到着・退室時刻入力
   * 送迎有無：行き／帰りチェックボックス
   * 児童名クリック ⇒ 児童詳細モーダルで随時加算をチェック
2. **支援時間自動計算**＝`退室－到着`（延長は同一ロジックで別フィールド保持）
3. **バリデーション**

   * 同児童・同日重複禁止
   * 時刻逆転禁止、必須時刻未入力禁止
4. **登録後即時計算**

   * 基本加算合計＋随時加算（児童単位で加算集計）
   * Cloud Function で日次売上 (`units × 単価`) を算出し `revenues` へ書込

### 5.3 ダッシュボード & KPI

* **視点切替**：全体／業態別／事業所別タブ

* **リアルタイム反映**：`revenues` 更新をサブスク

* **主要 KPI**

  | 指標        | 計算式                                   |
  | --------- | ------------------------------------- |
  | 日次売上      | `Σ units × 単価`（当日）                    |
  | 月次売上      | 当月分の合算                                |
  | 利用者数      | 当日利用児童数                               |
  | 平均支援時間    | `Σ 支援時間 ÷ 利用児童数`                      |
  | 加算取得率     | `取得加算単位 ÷ （取得可能加算単位）`                 |
  | **平均稼働率** | `(想定定員×営業日数) ÷ 実利用延べ人数` (想定定員=200 など) |

* **表示形式**：折線（売上推移）、棒グラフ（利用者数）、ゲージ or 円グラフ（稼働率・加算率）

* **書き出し**：表示範囲を CSV／PDF ダウンロード可

---

## 6. 非機能要件

| 区分          | 要件                                                                                            |
| ----------- | --------------------------------------------------------------------------------------------- |
| **技術スタック**  | Firebase （Auth / Firestore / Functions / Storage / Hosting）<br>フロント：React + TypeScript + Vite |
| **レスポンシブ**  | PC：入力・閲覧 100％対応<br>スマホ：閲覧 UI 最適化（入力は PC 想定）                                                   |
| **同時接続**    | 40 ユーザー程度（+ HQ）                                                                               |
| **バックアップ**  | Cloud Firestore automated backup + 月次エクスポート                                                   |
| **環境分割**    | `dev` `staging` `prod` の 3 プロジェクト<br>GitHub Actions で CI/CD                                   |
| **パフォーマンス** | 各画面初期ロード < 3 秒 / 操作レスポンス < 1 秒                                                                |
| **監査ログ**    | `userId`, `operation`, `timestamp` を Cloud Logging へ記録                                        |

---

## 7. 画面一覧（MVP）

1. **ログイン**
2. **HQ 管理者用**

   * 事業所一覧／編集
   * ユーザー一覧／編集
   * 加算マスタ設定
   * 全体ダッシュボード
3. **FC 管理者用**

   * 日報入力
   * 自事業所ダッシュボード
   * 在籍児童マスタ編集
4. **共通**

   * プロフィール／パスワード変更
   * CSV/PDF エクスポートダイアログ

---

## 8. 将来拡張

* **就労支援B型**：工賃計算ロジック・入力画面を追加
* **2 要素認証**・SSO
* **モバイル入力** UI（PWA 化）
* **帳票テンプレート**（国保連請求用 CSV など）

---

## 9. マイルストーン（案）

| フェーズ        | スコープ                 | 期間   |
| ----------- | -------------------- | ---- |
| **Phase 1** | 認証・マスタ管理・日報入力 MVP    | 6 週間 |
| **Phase 2** | ダッシュボード & CSV/PDF 出力 | 4 週間 |
| **Phase 3** | 就労支援B 型機能／モバイル閲覧最適化  | 4 週間 |
| **Phase 4** | 運用テスト & リリース         | 2 週間 |

---

## 10. 承認欄

| 承認者 | 所属 | 日付 | 署名 |
| --- | -- | -- | -- |
|     |    |    |    |

---

> **備考**
>
> * 単価・定員 200 名は例示。正式値が確定次第、計算式に反映。
> * 画面デザイン・UI 詳細は別紙「ワイヤーフレーム資料」にて提示予定。
